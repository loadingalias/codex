# cargo-rail configuration for OpenAI's `codex-rs`
# https://github.com/loadingalias/cargo-rail

# Platform targets (auto-detected via `cargo rail init`)
targets = [
  # Tier 2 (Common)
  "aarch64-unknown-linux-musl",
  "wasm32-unknown-unknown",
  "x86_64-unknown-linux-musl",
]

[unify]
detect_unused = true
exact_pin_handling = "preserve"  # Keep exact pins (patched ratatui/crossterm)
include_paths = true
include_renamed = true           # Codex uses renamed deps (package = "...")
major_version_conflict = "bump"  # Force highest version for leanest graph
max_backups = 3
msrv = true
pin_transitives = false
prune_dead_features = true
remove_unused = true
strict_version_compat = false    # Allow flexibility for maximum deduplication
transitive_host = "root"


[release]
# Codex uses workspace-level releases: `rust-v{version}`
# The rust-release.yml workflow expects this exact format
tag_prefix = ""
tag_format = "rust-v{version}"
require_clean = true
publish_delay = 5
create_github_release = false    # Handled by rust-release.yml workflow
sign_tags = false
changelog_path = "CHANGELOG.md"
changelog_relative_to = "workspace"
require_changelog_entries = false


[change-detection]
# Files that trigger rebuild_all (test everything)
infrastructure = [
  # CI/CD configuration
  ".github/workflows/**",

  # Rust workspace/toolchain (affects all crates)
  "Cargo.lock",
  "rust-toolchain.toml",
  ".cargo/config.toml",
  "clippy.toml",
  "rustfmt.toml",

  # Security/quality
  "deny.toml",

  # Nix build
  "default.nix",

  # cargo-rail config (changes affect change detection itself)
  ".config/rail.toml",
]

[change-detection.custom]
# Codegen scripts - trigger mcp-types rebuild validation
codegen = [
  "mcp-types/*.py",
]

# Windows-specific (allows platform-conditional CI)
windows = [
  "windows-sandbox-rs/**",
  "scripts/setup-windows.ps1",
]
